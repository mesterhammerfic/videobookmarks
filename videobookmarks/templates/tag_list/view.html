{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Viewing {{tag_list["name"]}}{% endblock %}</h1>
  <p> {{ tag_list["description"] }} </p>
{% endblock %}

{% block content %}
  <form method="post">
      <h2>Got a link? Tag a Video:</h2>
    <label for="yt_video_id">Youtube Video ID</label>
    <input name="yt_video_id" id="yt_video_id" value="{{ request.form['yt_video_id'] }}" required>
    <input type="submit" value="Tag Video">
  </form>

      <h2>Wanna browse? Or view existing tags:</h2>

     <div class="lists-container">
        <div class="list" id="list1">
            <h2>Tags</h2>
            <ul id="list1-content">
                <!-- List 1 content will be dynamically generated here -->
            </ul>
        </div>

        <div class="list" id="list2">
            <h2>Videos</h2>
            <ul id="list2-content">
                <!-- List 2 content will be dynamically generated here -->
            </ul>
        </div>
    </div>

    <script>
        // Arrays to store selected tags and videos
        const selectedTags = [];
        const selectedVideos = [];

        // Function to fetch data from an endpoint with JSON body
        async function fetchData(endpoint, body) {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            return data;
        }

        // Function to update the lists based on selected filters
        async function updateLists() {
            const tagListId = {{ tag_list["id"] }};

            const tagParams = { videoLinks: selectedVideos };
            const videoParams = { tags: selectedTags };

            // Fetch filtered data for tags and videos
            const [tagsData, videosData] = await Promise.all([
                fetchData(`/get_tags/${tagListId}`, tagParams),
                fetchData(`/get_videos/${tagListId}`, videoParams)
            ]);

            const list1Content = document.getElementById("list1-content");
            list1Content.innerHTML = ""; // Clear existing content

            tagsData.forEach(tag => {
                const listItem = document.createElement("li");
                const tagButton = document.createElement("button");
                tagButton.label = tag.tag;
                tagButton.textContent = `${tag.tag} (${tag.count})`;
                tagButton.classList.add("tag-button");
                tagButton.disabled = !tag.show; // Disable button if show is false

                // Check if the tag is in the selectedTags array
                if (selectedTags.includes(tag.tag)) {
                    tagButton.classList.add("selected");
                }

                // Toggle the selected state when clicked
                tagButton.addEventListener("click", () => {
                    if (selectedTags.includes(tag.tag)) {
                        // Deselect the tag
                        const index = selectedTags.indexOf(tag.tag);
                        selectedTags.splice(index, 1);
                    } else {
                        // Select the tag
                        selectedTags.push(tag.tag);
                    }

                    updateLists(); // Update the lists based on selections
                });

                list1Content.appendChild(listItem);
                listItem.appendChild(tagButton);
            });

            const list2Content = document.getElementById("list2-content");
            list2Content.innerHTML = ""; // Clear existing content

            videosData.forEach(video => {
                const listItem = document.createElement("li");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = video.link;
                checkbox.classList.add("video-checkbox");
                checkbox.disabled = !video.show; // Disable checkbox if show is false

                // Check if the video is in the selectedVideos array
                if (selectedVideos.includes(video.link)) {
                    checkbox.checked = true;
                }

                // Toggle the selected state when clicked
                checkbox.addEventListener("change", () => {
                    if (selectedVideos.includes(video.link)) {
                        // Deselect the video
                        const index = selectedVideos.indexOf(video.link);
                        selectedVideos.splice(index, 1);
                    } else {
                        // Select the video
                        selectedVideos.push(video.link);
                    }

                    updateLists(); // Update the lists based on selections
                });
                const videoItem = document.createElement("div");
                videoItem.classList.add("video-item");

                // Create a checkbox for video selection
                const videoCheckbox = document.createElement("input");
                videoCheckbox.type = "checkbox";
                videoCheckbox.value = video.link;
                videoCheckbox.classList.add("video-checkbox");

                // Create a link to open the video when the thumbnail is clicked
                const videoLink = document.createElement("a");
                videoLink.href = `/tagging/{{ tag_list["id"] }}/${video.link}`;
                videoLink.target = "_blank"; // Open the link in a new tab
                videoLink.classList.add("video-thumbnail-link");

                const thumbnail = document.createElement("img");
                thumbnail.src = video.thumbnail;
                thumbnail.classList.add("video-thumbnail");

                const videoDetails = document.createElement("div");
                videoDetails.classList.add("video-details");

                const titleElement = document.createElement("div");
                titleElement.classList.add("video-title");
                titleElement.textContent = video.title;

                const tagCountElement = document.createElement("div");
                tagCountElement.classList.add("video-tag-count");
                tagCountElement.textContent = `Number of Tags: ${video.num_tags}`;

                videoDetails.appendChild(titleElement);
                videoDetails.appendChild(tagCountElement);

                videoLink.appendChild(thumbnail);
                videoItem.appendChild(videoCheckbox);
                videoItem.appendChild(videoLink);
                videoItem.appendChild(videoDetails);

                list2Content.appendChild(videoItem);
            });
        }

        // Initial load with no filters
        updateLists();
    </script>


{% endblock %}