{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Viewing {{tag_list["name"]}}{% endblock %}</h1>
  <p> {{ tag_list["description"] }} </p>
{% endblock %}

{% block content %}
  <form method="post">
      <h2>Got a link? Tag a Video:</h2>
    <label for="yt_video_id">Youtube Video ID</label>
    <input name="yt_video_id" id="yt_video_id" value="{{ request.form['yt_video_id'] }}" required>
    <input type="submit" value="Tag Video">
  </form>

      <h2>Wanna browse? Or view existing tags:</h2>

     <div class="lists-container">
        <div class="list" id="list1">
            <h2>List 1 (Tags)</h2>
            <ul id="list1-content">
                <!-- List 1 content will be dynamically generated here -->
            </ul>
        </div>

        <div class="list" id="list2">
            <h2>List 2 (Videos)</h2>
            <ul id="list2-content">
                <!-- List 2 content will be dynamically generated here -->
            </ul>
        </div>
    </div>

    <script>
        // Arrays to store selected tags and videos
        const selectedTags = [];
        const selectedVideos = [];

        // Function to fetch data from an endpoint with JSON body
        async function fetchData(endpoint, body) {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            return data;
        }

        // Function to update the lists based on selected filters
        function updateLists() {
            // Replace 'tag_list_id' with the actual integer you want to use
            const tagListId = 1;

            const tagParams = { videoLinks: selectedVideos };
            const videoParams = { tags: selectedTags };

            // Fetch filtered data for tags and videos
            fetchData(`/get_tags/${tagListId}`, tagParams)
                .then(tagsData => {
                    const list1Content = document.getElementById("list1-content");
                    list1Content.innerHTML = ""; // Clear existing content

                    tagsData.forEach(tag => {
                        const listItem = document.createElement("li");
                        const tagButton = document.createElement("button");
                        tagButton.textContent = `${tag.tag} (${tag.count})`;
                        tagButton.label = `${tag.tag} (${tag.count})`;
                        tagButton.classList.add("tag-button");
                        tagButton.disabled = !tag.show; // Disable button if show is false

                        // Check if the tag is in the selectedTags array
                        if (selectedTags.includes(tag.tag)) {
                            tagButton.classList.add("selected");
                        }

                        // Toggle the selected state when clicked
                        tagButton.addEventListener("click", () => {
                            if (selectedTags.includes(tag.tag)) {
                                // Deselect the tag
                                const index = selectedTags.indexOf(tag.tag);
                                selectedTags.splice(index, 1);
                            } else {
                                // Select the tag
                                selectedTags.push(tag.tag);
                            }

                            updateLists(); // Update the lists based on selections
                        });

                        list1Content.appendChild(listItem);
                        listItem.appendChild(tagButton);
                    });
                });

            fetchData(`/get_videos/${tagListId}`, videoParams)
                .then(videosData => {
                    const list2Content = document.getElementById("list2-content");
                    list2Content.innerHTML = ""; // Clear existing content

                    videosData.forEach(video => {
                        const listItem = document.createElement("li");
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = video.link;
                        checkbox.classList.add("video-checkbox");
                        checkbox.disabled = !video.show; // Disable checkbox if show is false

                        // Check if the video is in the selectedVideos array
                        if (selectedVideos.includes(video.link)) {
                            checkbox.checked = true;
                        }

                        // Toggle the selected state when clicked
                        checkbox.addEventListener("change", () => {
                            if (selectedVideos.includes(video.link)) {
                                // Deselect the video
                                const index = selectedVideos.indexOf(video.link);
                                selectedVideos.splice(index, 1);
                            } else {
                                // Select the video
                                selectedVideos.push(video.link);
                            }

                            updateLists(); // Update the lists based on selections
                        });

                        listItem.appendChild(checkbox);
                        const label = document.createElement("label");
                        label.textContent = `Video Link: ${video.link}, Tags: ${video.num_tags}`;
                        listItem.dataset.tags = video.tags.join(",");
                        listItem.appendChild(label);
                        list2Content.appendChild(listItem);
                    });
                });
        }

        // Initial load with no filters
        updateLists();
    </script>


{% endblock %}