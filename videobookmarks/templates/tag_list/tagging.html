{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Tagging for {{ tag_list["name"] }}{% endblock %}</h1>
  <p>{{ tag_list["description"] }}</p>
{% endblock %}

{% block content %}
<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div>
    <form class="link-input">
        <input type="text" name="tag" id="tag-input"
               value="{{ request.form['tag'] }}"
               required
               placeholder="Add tag"
               oninvalid="must give tag a name"
               list="tagSuggestions"
        >
        <datalist id="tagSuggestions"></datalist>
        <button id="add-tag-button" class="button">Add Tag</button>
    </form>
    <table id="tag-list">
      <tbody>
        <!-- Tags will be displayed here -->
      </tbody>
    </table>
    <script>
        // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '600',
          width: '900',
          videoId: '{{ yt_video_id }}',
          playerVars: {
            'playsinline': 1
          },
          events: {
            'onReady': onPlayerReady,
          }
        });
      }
      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

    // handle buttons and form for adding tag
    const tagInput = document.getElementById('tag-input');
    const addTagButton = document.getElementById('add-tag-button');

    addTagButton.addEventListener('click', (event) => {
      event.preventDefault()
      const tagName = tagInput.value;
      const currentTime = player.getCurrentTime();

      // Create a new tag on the server using AJAX
      const url = '/add_tag';

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          yt_video_id: '{{ yt_video_id }}',
          tag_list_id: {{ tag_list["id"] }},
          tag: tagName,
          timestamp: currentTime
        })
      })
        .then(response => response.json())
        .then(() => {
          // After adding the tag, refresh the tag list
          refreshTagList({{ video_id }}, {{ tag_list["id"] }});
          tagInput.value = '';
        })
        .catch(error => {
          console.error('Error adding tag:', error);
        });
    });

    // create seek to function so that users can click on a timestamp
      function jumptoTime(timepoint) {
        event.preventDefault();
        player.seekTo(timepoint, true);
        player.playVideo();
      }

      function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      const formattedTime = `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
      return formattedTime;
    }
    // create a function to add tags
    function addTag(tagName, time) {
      const tagList = document.getElementById('tag-list').getElementsByTagName('tbody')[0];
      const row = tagList.insertRow(-1); // Insert a row at the end of the table
      const cell1 = row.insertCell(0);
      const cell2 = row.insertCell(1);

      cell1.innerHTML = tagName;

      const timestampButton = document.createElement('button');
      timestampButton.textContent = formatTime(time);
      timestampButton.addEventListener('click', () => {
        player.seekTo(time);
      });
      cell2.appendChild(timestampButton);
    }

    // create request to dynamically update tag list when users updates tags
      function refreshTagList(videoId, tagListId) {
      const url = `/video_tags/${videoId}/${tagListId}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          // Clear the existing tag list (tbody)
          const tagList = document.getElementById('tag-list').getElementsByTagName('tbody')[0];
          tagList.innerHTML = '';

          // Process the retrieved data and add tags to the tag list
          data.forEach(tag => {
            addTag(tag.tag, tag.timestamp);
            tagSuggestions = document.getElementById('tagSuggestions');
            tagSuggestion = document.createElement('option');
            tagSuggestion.textContent = tag.tag;
            tagSuggestion.value = tag.tag;
            tagSuggestions.appendChild(tagSuggestion)
          });
        })
        .catch(error => {
          console.error('Error fetching tags:', error);
        });
    }
    refreshTagList({{ video_id }}, {{ tag_list["id"] }});

      // add event listener for timestamp tags
      const tagList = document.getElementById('tag-list');
        tagList.addEventListener('click', (event) => {
          if (event.target && event.target.matches('button.timestamp')) {
            const time = parseFloat(event.target.dataset.timestamp);
            player.seekTo(time);
          }
        });
    </script>

{% endblock %}